---
layout: post
title: mrtrix3 via apptainer/sandbox - DTI fiber tracking - Advanced tutorial
---
To get started to create a network graph of nodes and edges, please follow: [BATMAN](https://osf.io/fkyht/). This tutorial will be rather long, but each step is equally important. Another purporse of this tutorial is that it can serve as a wiki for integrating DTI-mrtrix3 processing into PUMI.

# Folder structure: BIDS
Folder strcucture is everything when it comes to big data analyses/multicenter collaborations etc. For this tutorial, it is recommended that you have a [BIDS](https://bids-standard.github.io/bids-starter-kit/folders_and_files/folders.html) folder architecture. Assume that there is a subject called 100408, in the folder /groups/pni/datasets/HCP_YA/. Now 100408 should have two folders/files, i.e., 
- **anat**/100408_T1w.nii.gz and 
- **dwi**/100408_3T_DWI_dir96_LR.bval
- dwi/100408_3T_DWI_dir96_LR.bvec
- dwi/100408_3T_DWI_dir96_LR.nii.gz
- dwi/100408_3T_DWI_dir96_RL.bval
- dwi/100408_3T_DWI_dir96_RL.bvec
- dwi/100408_3T_DWI_dir96_RL.nii.gz
                                 

# Creating nodes/anatomical regions of interest for DTI-based tractography
A more comprehensive way to create the nodes is using [freesurfer](https://k87rte.github.io/clusterDocs/2023/09/07/freesurfer.html). Once the freesurfer process is completed using recon-all, you can either use the aparc+aseg.mgz with ~34 regions per hemi, or aparc.a2009+aseg.mgz with ~74 nodes. Here, we will use the latter, i.e. creating a final connectome with (74rh + 74rh = 148 nodes, otherwise 148 x 148 adjacency symmetric matrix). 

# Now starts the lengthy processing, i.e., mrtrix3
mrtrix3 is a software package, avaialbe with singularity as well. It will help us obtain the 'edges' for the freesurfer-based 'nodes' to make a connectome. HCP1200 has data acquired in both LR and RL phase-encoding directions.

## 1. convert .nii.gz to .mif for LR dwi image
```
singularity exec /homes/rkotikalapudi/containers/mrtrix3_latest.sif \
            mrconvert -force /groups/pni/datasets/HCP_YA/${var}/dwi/${var}_3T_DWI_dir96_LR.nii.gz \
            /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/LR.mif \
            -fslgrad /groups/pni/datasets/HCP_YA/${var}/dwi/${var}_3T_DWI_dir96_LR.bvec \
            /groups/pni/datasets/HCP_YA/${var}/dwi/${var}_3T_DWI_dir96_LR.bval
```
Now the LR.mif will have info of the image, bval and bvec.

## 2. denoise the data
```
singularity exec /homes/rkotikalapudi/containers/mrtrix3_latest.sif \
            dwidenoise -force /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/LR.mif \
            /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/LR_denoise.mif \
            -noise /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/LR_noise.mif
```

## 3. get the residual for observation i.e. orig - denoised
```
singularity exec /homes/rkotikalapudi/containers/mrtrix3_latest.sif \
            mrcalc -force /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/LR.mif \
            /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/LR_denoise.mif \
            -subtract /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/LR_residual.mif
```

## 4, 5, 6. repeat steps 1-3, but for RL dwi image
```
singularity exec /homes/rkotikalapudi/containers/mrtrix3_latest.sif \
            mrconvert -force /groups/pni/datasets/HCP_YA/${var}/dwi/${var}_3T_DWI_dir96_RL.nii.gz \
            /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/RL.mif \
            -fslgrad /groups/pni/datasets/HCP_YA/${var}/dwi/${var}_3T_DWI_dir96_RL.bvec \
            /groups/pni/datasets/HCP_YA/${var}/dwi/${var}_3T_DWI_dir96_RL.bval

singularity exec /homes/rkotikalapudi/containers/mrtrix3_latest.sif \
            dwidenoise -force /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/RL.mif \
            /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/RL_denoise.mif \
            -noise /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/RL_noise.mif

singularity exec /homes/rkotikalapudi/containers/mrtrix3_latest.sif \
            mrcalc -force /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/RL.mif \
            /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/RL_denoise.mif \
            -subtract /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/RL_residual.mif
```

## 7. remove ringing effects - otherwise called degibbs for LR and RL derivatives
```
singularity exec /homes/rkotikalapudi/containers/mrtrix3_latest.sif \
    mrdegibbs -force /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/LR_denoise.mif \
    /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/LR_denoise_degibbs.mif

singularity exec /homes/rkotikalapudi/containers/mrtrix3_latest.sif \
    mrdegibbs -force /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/RL_denoise.mif \
    /groups/pni/datasets/HCP_YA/derivatives/mrtrix3/${var}/RL_denoise_degibbs.mif
```


